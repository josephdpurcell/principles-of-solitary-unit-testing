<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Principles of Solitary Unit Testing</title>
    <meta name="description" content="Principles of Solitary Unit Testing">
    <meta name="author" content="Joseph D. Purcell">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="palantirnet-theme/css/styles.css" id="theme">
    <link rel="stylesheet" href="css/overrides.css" id="theme">

    <!-- Code syntax highlighting
    <link rel="stylesheet" href="lib/css/zenburn.css">
    -->

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'palantirnet-theme/css/print/pdf.css' : 'palantirnet-theme/css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>
  <!-- Change body class to "dark" if you prefer a dark theme, or "light" if you'd rather have a light theme-->
  <body class="light">
    <div class="reveal" style="font-size:3em">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">

        <!-- Introduction -->
        <section>
          <section class="title" style="font-size:80%">
            <h1>Principles of<br>Solitary Unit Testing</h1>
            <h4>– DrupalCon Barcelona 2015 –</h4>
            <h3>by Joseph D. Purcell</h3>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h2>Who am I?</h2>
            <ul>
              <li class="fragment">Engineer at Palantir</li>
              <li class="fragment">Part of web dev since 2003</li>
              <li class="fragment">&lt;3 learning and teaching</li>
            </ul>
            <aside class="notes">
              <ul>
                <li>Broad experience</li>
              </ul>
            </aside>
          </section>

          <section>
            <h2>Who are you?</h2>
            <ul>
              <li class="fragment">You have some idea of unit testing.</li>
              <li class="fragment">You want to be better at it.</li>
            </ul>
            <aside class="notes">
              <ul>
                <li>Also, want to have better software designs</li>
              </ul>
            </aside>
          </section>

          <section>
            <pre style="font-size:120%;text-align:center;">
  29513736
x 92842033
  _________

  ?
            </pre>
            <aside class="notes">
              <ul>
                <li>What is the process you use?</li>
                <li>An algorithm</li>
                <li>Marc Sanz set record doing 10 diff sets in 4.5 min (<a href="http://www.recordholders.org/en/list/memory.html#8x8">source</a>)</li>
              </ul>
            </aside>
          </section>

          <section>
            <pre style="font-size:120%;text-align:center;">
write a bubble sort
            </pre>
            <aside class="notes">
              <ul>
                <li>What is the process you use?</li>
                <li>TDD</li>
              </ul>
            </aside>
          </section>

          <section>
            <pre style="font-size:120%;text-align:center;">
<b>write Drupal 8</b>
            </pre>
            <aside class="notes">
              <ul>
                <li>What is the process you use?</li>
                <li>Solitary TDD</li>
              </ul>
            </aside>
          </section>

          <section>
            <h2>We need processes<br>
            to help us do things well.</h2>
            <ul style="font-size:85%">
              <li class="fragment">Algorithms help you do arithmetic.</li>
              <li class="fragment">Test Driven Development (TDD) helps you write software.</li>
              <li class="fragment"><b>Solitary Unit Testing helps you write well designed software.</b></li>
            </ul>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h1>Overview</h1>
            <ol style="list-style-type:upper-roman">
              <li class="fragment">Definition</li>
              <li class="fragment">Principles</li>
              <li class="fragment">Test&nbsp;Smells</li>
              <li class="fragment">Motivations</li>
            </ol>
            <aside class="notes">
            </aside>
          </section>
        </section>

<!--
===============================================================================
               Part I. Definition of Solitary Unit Test
===============================================================================
-->

        <section>
          <section>
            <h2>I. Definition</h2>
            <aside class="notes">
              <ul>
                <li>How many know what test doubles are?</li>
                <li>How many know what it means to mock the boundary?</li>
                <li>Problem: many definitions</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>What is a "unit test"?</h3>
            <aside class="notes">
              <ul>
                <li>WikiPedia is most often quoted; but really? that's the best we can do?</li>
                <li>Let's be more careful about definition</li>
              </ul>
            </aside>
          </section>

          <section>
            <blockquote>
            "[I]t's a situational thing - the team decides what
            makes sense to be a unit for the purposes of their
            understanding of the system and its testing."
            <p class="attribution">&mdash; Martin Fowler, <a href="http://martinfowler.com/bliki/UnitTest.html">martinfowler.com</a></p>
            </blockquote>
            <aside class="notes">
              This does get at the heart of how to approach it, but it's nothing you can build definitions on.
            </aside>
          </section>

          <section>
            <p>A unit test verifies a function's correctness<br>
            against a specification.</p>
            <aside class="notes">
              <ul>
                <li>"verify" is true to roots: formal verification</li>
                <li>function = constructor, method, or function</li>
                <li>there is nothing you can unit test that could not be described by this definition</li>
              </ul>
            </aside>
          </section>

          <section>
            <p style="padding-left:3em;text-align:left">A unit is...</p>
            <ul>
              <li>a function (e.g. <code>t</code>)</li>
              <li>a method on a class (e.g. <code>__construct</code>)</li>
              <li>a script (.e.g <code>update.php</code>)</li>
            </ul>
            <p class="fragment" style="padding-left:3em;text-align:left">...<b>one thing</b></p>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <p>There are two challenges with testing a unit:</p>
            <ol style="width:60%">
              <li>indirect inputs (shared state)</li>
              <li>indirect outputs (side effects)</li>
            </ol>
            <br>
            <br>
            <p class="fragment">... <em>anything that makes it not a pure function.</em></p>
            <aside class="notes">
              <ul>
                <li>shared state: globals, env vars, db, fs, net</li>
                <li>side effects: collaborators, db, fs, net</li>
              </ul>
            </aside>
          </section>

          <section>
            <p>Test doubles are the tools we use to test code that has shared state and/or side effects.</p>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Test Doubles</h3>
            <dl>
              <dt class="fragment" data-fragment-index="1">Dummy</dt>
                <dd class="fragment" data-fragment-index="1">never called</dd>
              <dt class="fragment" data-fragment-index="2">Fake</dt>
                <dd class="fragment" data-fragment-index="2">is called</dd>
              <dt class="fragment" data-fragment-index="3">Stub</dt>
                <dd class="fragment" data-fragment-index="3">provide indirect inputs</dd>
              <dt class="fragment" data-fragment-index="4">Spy</dt>
                <dd class="fragment" data-fragment-index="4">provide indirect inputs, capture indirect outputs</dd>
              <dt class="fragment" data-fragment-index="5">Mock</dt>
                <dd class="fragment" data-fragment-index="5">provide indirect inputs, verify indirect outputs</dd>
            </dl>
            <aside class="notes">
              <ul>
                <li>Definitions are inconsistent, see xUnit book</li>
                <li>PHPUnit terminology does not make it clear which you're doing</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Dummy</h3>
            <pre>
              <code>
  $dummy = $this->getMockBuilder('SomeClass')->getMock();
  $cut = new ClassUnderTest($dummy);

  $response = $cut->methodDoesntNeedDummy();

  // Make an assertion.
              </code>
            </pre>
            <p style="font-size:80%">... or just use <code>null</code>?</p>
            <aside class="notes">
              <ul>
                <li>Dummy is for "utility" value</li>
                <li>Assuming this doesn't get called.</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Fake</h3>
            <pre>
              <code>
  $fs = new FakeFileSystem();
  $cut = new ClassUnderTest($fs);

  $response = $cut->write('A string going to a log.');

  // Make an assertion.
              </code>
            </pre>
            <p style="font-size:80%">Example: write a fake for a logger.</p>
            <aside class="notes">
              <ul>
                <li>Fake reduces complexity</li>
                <li>e.g. you might fake a log class</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Stub</h3>
            <pre>
              <code>
  $stub = $this->getMockBuilder('User')->getMock();
  $stub->method('getFirstName')->willReturn('First');
  $stub->method('getLastName')->willReturn('Last');
  $cut = new ClassUnderTest($stub);

  $fullName = $cut->getFullName();

  $this->assertEquals('First Last', $fullName);
              </code>
            </pre>
            <p style="font-size:80%">Like a dummy, but is called and returns values.</li>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Spy</h3>
            <pre>
              <code>
  $user = $this->prophet->prophesize('User');
  $cut = new ClassUnderTest($user->reveal());

  $cut->getFullName();

  $user->getFirstName()->shouldHaveBeenCalled();
  $user->getLastName()->shouldHaveBeenCalled();
              </code>
            </pre>
            <p style="font-size:80%">Like a stub, but captures calls.</li>
            <aside class="notes">
              <ul>
                <li>You can provide values with a spy</li>
                <li>Must use prophecy</li.
              </ul>
            </aside>
          </section>

          <section>
            <h3>Mock</h3>
            <pre>
              <code>
  $stub = $this->getMockBuilder('User')->getMock();
  $stub->expects($this->once())->method('getFirstName')->willReturn('First');
  $stub->expects($this->once())->method('getLastName')->willReturn('Last');
  $cut = new ClassUnderTest($stub);

  $fullName = $cut->getFullName();
              </code>
            </pre>
            <p style="font-size:80%">Like a spy, but runs assertions on execution of CUT.</li>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Recap of Test Doubles</h3>
            <dl>
              <dt>Dummy</dt>
                <dd>never called</dd>
              <dt>Fake</dt>
                <dd>is called</dd>
              <dt>Stub</dt>
                <dd>provide indirect inputs</dd>
              <dt>Spy</dt>
                <dd>provide indirect inputs, capture indirect outputs</dd>
              <dt>Mock</dt>
                <dd>provide indirect inputs, verify indirect outputs</dd>
            </dl>
            <aside class="notes">
              Questions?
            </aside>
          </section>

          <section>
            <h3>What should you double?</h3>
            <p class="fragment">It depends if you're doing<br>
            Sociable or Solitary unit testing.</p>
            <aside class="notes">
              <ul>
                <li>this is the big question</li>
                <li>doubles smell of danger: over-specification in tests, slow tests, fragile tests</li>
              </ul>
            </aside>
          </section>

          <section>
            <div style="float:left;width:46%">
              <h3>Sociable</h3>
              <ol>
                <li class="fragment" data-fragment-index="1">Cross some boundaries</li>
                <li class="fragment" data-fragment-index="2">One or more concrete classes during test</li>
              </ol>
            </div>
            <div style="float:left;width:8%">
              <h3>vs</h3>
            </div>
            <div style="float:right;width:46%">
              <h3>Solitary</h3>
              <ol>
                <li class="fragment" data-fragment-index="1">Never cross boundaries</li>
                <li class="fragment" data-fragment-index="2">One concrete class during test</li>
              </ol>
            </div>
            <div style="width:100%;float:left;font-size:80%;margin-top:2em">
              <p class="fragment" data-fragment-index="2">Source: Jay Fields, "<a href="https://leanpub.com/wewut">Working Effectively With Unit Tests</a>"</p>
            </div>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>What is a boundary?</h3>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <blockquote>
              A boundary is "a database, a queue,<br>
              another system, or even an ordinary class<br>
              if that class is 'outside' the area your trying<br>
              to work with or are responsible for"
              <p class="attribution">&mdash; William E. Caputo, <a href="http://www.williamcaputo.com/archives/000019.html">www.williamcaputo.com</a></p>
            </blockquote>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3 style="font-size:120%">What does "one concrete class" mean?</h3>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <ul>
              <li>Use a double for dependencies.</li>
              <li>Collaborators that return objects<br>
              should return doubles.</li>
              <li>No statics.</li>
              <li><em>Caveat: value objects don't count.</em></li>
            </ul>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Consider three levels of testing:</h3>
            <ol>
              <li>Solitary (e.g. UnitTestBase)</li>
              <li>Sociable (e.g. KernelTestBase)</li>
              <li>Functional (e.g. BrowserTestBase)</li>
            </ol>
            <br>
            <br>
            <p><em>Point of confusion: these can all be written in PHPUnit.</em></p>
            <aside class="notes">
            </aside>
          </section>

        </section>

<!--
===============================================================================
              Part II. Principles of Solitary Unit Testing
===============================================================================
-->

        <section>
          <section>
            <h2>II. Principles</h2>
            <aside class="notes">
              So, now we know that solitary unit testing is awesome, how do we do it?
            </aside>
          </section>

          <section>
            <h3>Layout of a Unit Test</h3>
            <dl>
              <dt>Arrange</dt>
                <dd>Arrange all necessary preconditions and inputs. </dd>
              <dt>Act</dt>
                <dd>Act on the object or method under test.</dd>
              <dt>Assert</dt>
                <dd>Assert that the expected results have occurred.</dd>
            </dl>
            <div style="width:100%;float:left;font-size:80%;margin-top:2em">
              <p>Source: Cunningham Ward, <a href="http://c2.com/cgi/wiki?ArrangeActAssert">c2.com</a></p>
            </div>
            <aside class="notes">
              When looking at these examples, this is how you read them
            </aside>
          </section>

          <section>
            <h3>Example 1</h3>
            <code>Drupal\Core\Batch\BatchStorage</code>
          </section>

          <section>
            <pre style="font-size:75%">
              <code>
  public function load($id) {
    $this->session->start();
    $batch = $this->connection->query("SELECT batch FROM {batch} WHERE bid = :bid AND token = :token", array(
      ':bid' => $id,
      ':token' => $this->csrfToken->get($id),
    ))->fetchField();
    if ($batch) {
      return unserialize($batch);
    }
    return FALSE;
  }
              </code>
            </pre>
            <aside class="notes">
              <ul>
                <li>What shared state or side effects are in here?
                  <ul>
                    <li>indirect output: session start</li>
                    <li>indirect input: get data from db</li>
                  </ul>
                </li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Let's test using a mock</h3>
          </section>

          <section>
            <pre style="font-size:75%;overflow:scroll;" class="hljs php">
  public function test_load_starts_session() {
    $statement = $this->getMock(StatementInterface::class);
    $connection = $this->getMockBuilder(Connection::class)
        ->disableOriginalConstructor()
        ->getMock();
    $connection->method('query')->willReturn($statement);
    $session = $this->getMock(SessionInterface::class);
    <b>$session->expects($this->once())->method('start');</b>
    $csrf_token = $this->getMockBuilder(CsrfTokenGenerator::class)
        ->disableOriginalConstructor()
        ->getMock();
    $batch_storage = new BatchStorage($connection, $session, $csrf_token);

    $batch_storage->load(123);
  }
            </pre>
            <aside class="notes">
              <ul>
                <li>Did we meet the two principles? Yes</li>
                <li>What is the problem?</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Problem: we fail to assert last.</h3>
            <h3 class="fragment">
          </section>

          <section>
            <h3>Let's test using a spy</h3>
          </section>

          <section>
            <pre style="font-size:75%;overflow:scroll;" class="hljs php">
  public function test_load_starts_session() {
    $prophet = new Prophet();
    $statement = $this->getMock(StatementInterface::class);
    $connection = $this->getMockBuilder(Connection::class)
        ->disableOriginalConstructor()
        ->getMock();
    $connection->method('query')->willReturn($statement);
    $session = $prophet->prophesize(SessionInterface::class);
    $csrf_token = $this->getMockBuilder(CsrfTokenGenerator::class)
        ->disableOriginalConstructor()
        ->getMock();
    $batch_storage = new BatchStorage($connection, $session->reveal(), $csrf_token);

    $batch_storage->load(123);

    <b>$session->start()->shouldHaveBeenCalled();</b>
  }
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Example 2</h3>
            <code style="font-size:78%">Drupal\Core\EventSubscriber\MaintenanceModeSubscriber</code>
          </section>

          <section>
            <pre style="font-size:65%;">
              <code>
  public function onKernelRequestMaintenance(GetResponseEvent $event) {
    $route_match = RouteMatch::createFromRequest($event->getRequest());
    if ($this->maintenanceMode->applies($route_match)) {
      \Drupal::service('page_cache_kill_switch')->trigger();
      if (!$this->maintenanceMode->exempt($this->account)) {
        drupal_maintenance_theme();
        $content = Xss::filterAdmin(SafeMarkup::format($this->config->get('system.maintenance')->get('message'), array(
          '@site' => $this->config->get('system.site')->get('name'),
        )));
        $response = $this->bareHtmlPageRenderer->renderBarePage(['#markup' => $content], $this->t('Site under maintenance'), 'maintenance_page');
        $response->setStatusCode(503);
        $event->setResponse($response);
      }
      else {
        if ($route_match->getRouteName() != 'system.site_maintenance_mode') {
          if ($this->account->hasPermission('administer site configuration')) {
            $this->drupalSetMessage($this->t('Operating in maintenance mode. <a href="@url">Go online.</a>', array('@url' => $this->urlGenerator->generate('system.site_maintenance_mode'))), 'status', FALSE);
          }
          else {
            $this->drupalSetMessage($this->t('Operating in maintenance mode.'), 'status', FALSE);
          }
        }
      }
    }
  }
              </code>
            </pre>
            <aside class="notes">
              <ul>
                <li>What are the side effects or shared state?</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3>We can't solitary test this.</h3>
            <ol class="fragment">
              <li><code>\Drupal::service</code></li>
              <li><code>drupal_maintenance_theme()</code></li>
              <li><code>Xss::filterAdmin</code></li>
              <li><code>SafeMarkup::format</code></li>
            </ol>
            <aside class="notes">
              <ul>
                <li>Can you name them?
                  <ol>
                    <li><code>\Drupal::service</code></li>
                    <li><code>drupal_maintenance_theme()</code></li>
                    <li><code>Xss::filterAdmin</code></li>
                    <li><code>SafeMarkup::format</code></li>
                  </ol>
                </li>
              </ul>
            </aside>
          </section>

          <section>
            <h3 style="text-align:left">Let's...</h3>
            <ol>
              <li>Delete the untestable code and re-implement later.</li>
              <li>Break the subscriber in two:
                <ul>
                  <li>setting response</li>
                  <li>showing a message</li>
                </ul>
              </li>
            </ol>
          </section>

          <section>
            <h3>Example 2: Revision 1, Part 1</h3>
            <code style="font-size:78%">Drupal\Core\EventSubscriber\MaintenanceModePageOverrideSubscriber</code>
          </section>

          <section>
            <p>Create an interface to implement later<br>
            <code>Drupal\Core\Site\MaintenanceModePageInterface</code></p>

            <pre style="font-size:65%">
              <code>
namespace Drupal\Core\Site;

/**
 * Defines the interface for a maintenance mode page.
 */
interface MaintenanceModePageInterface {

  /**
   * Returns a Response object.
   *
   * @return \Drupal\Core\Render\HtmlResponse
   *   The response object for a maintenance page.
   */
  public function getResponse();

}
            </code>
          </pre>

          </section>

          <section>
            <p>Create a subscriber to override page rendering</p>
            <code style="font-size:78%">Drupal\Core\EventSubscriber\MaintenanceModePageOverrideSubscriber</code>
            <pre style="font-size:65%">
              <code>
  public function onKernelRequestMaintenance(GetResponseEvent $event) {
    $route_match = RouteMatch::createFromRequest($event->getRequest());
    if ($this->maintenanceMode->applies($route_match)) {
      if (!$this->maintenanceMode->exempt($this->account)) {
        $response = $this->maintenancePage->getResponse();
        $event->setResponse($response);
      }
    }
  }
              </code>
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3 style="font-size:1.25em">Improvements:</h3>
            <ul>
              <li>Now our class does one thing</li>
              <li>Which means we can test one thing</li>
              <li>The class now has 3 dependencies instead of 6</li>
              <li>It's more readable</li>
              <li>It's easier to test</li>
            </ul>
          </section>

          <section>
            <pre style="font-size:75%;overflow:scroll;" class="hljs php">
  public function test_applicable_page_sets_maintenance_page_response() {
    $prophet = new Prophet();
    $account = $this->getMock(AccountInterface::class);
    $maintenance_mode = $this->getMock(MaintenanceModeInterface::class);
    $maintenance_mode->method('applies')->willReturn(true);
    <span class="fragment bold">$maintenance_page = $this->getMock(MaintenanceModePageInterface::class);</span>
    $response = $this->getMock(HtmlResponse::class);
    <span class="fragment bold">$maintenance_page->method('getResponse')->willReturn($response);</span>
    $subscriber = new MaintenanceModePageOverrideSubscriber($maintenance_mode, $account, $maintenance_page);
    $request = $this->getMock(Request::class);
    $request->attributes = $this->getMock(ParameterBag::class);
    $event = $prophet->prophesize(GetResponseEvent::class);
    $event->setResponse(Argument::cetera())->willReturn();
    $event->getRequest()->willReturn($request);

    $subscriber->onKernelRequestMaintenance($event->reveal());

    <span class="fragment bold">$event->setResponse($response)->shouldHaveBeenCalled();</span>
  }
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

        </section>

<!--
===============================================================================
              Part III. Solitary Unit Test Smells
===============================================================================
-->

        <section>
          <section>
            <h2>III. Test Smells</h2>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>Obscure Test</h3>
            <p>What is this test doing!?</p>
            <aside class="notes">
              <ul>
                <li>side effects and shared state &rarr; complex tests</li>
                <li>Solutions:
                  <ul>
                    <li>use ObjectMother or DataBuilder</li>
                    <li>use custom assertions</li>
                    <li>expect literals</li>
                    <li>avoid use of setUp; use inline setup</li>
                  </ul>
                </li>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Try: Object Mother</h3>
            <pre>
              <code>
              class UserMother {
                public function getJohnDoe() {
                  var $user = new User();
                  $user->setFirstName('John');
                  $user->setLastName('Doe');
                  return $user;
                }
              }
              </code>
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Try: Data Builder</h3>
            <pre>
              <code>
              class UserBuilder {
                protected $user;

                public function __construct() {
                  $this->user = new User();
                }

                public function withNoPosts() {
                  foreach ($this->user->getPosts() as $post) {
                    $this->user->removePost($post);
                  }
                  return $this;
                }

                public function with10Posts() {
                  for (var $i = 0; $i < 10; $i++) {
                    $this->user->addPost(new Post());
                  }
                  return $this;
                }

                public function build() {
                  return $this->user;
                }
              }
              </code>
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Try: Custom Assertion</h3>
            <pre>
              <code>
              class UserTest extends \PHPUnit_Framework_TestCase {

                use UserAssertions;

                public function test_something_complicated() {
                  // Assemble...

                  // Activate...

                  $this->assertHasNoPosts();
                }
              }
              </code>
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Try: Expect Literals</h3>
            <p style="text-align:left">Bad:</p>
            <pre>
              <code>
                $this->assertEquals('<div>' . $something . '</div>', $value);
              </code>
            </pre>
            <p style="text-align:left">Good:</p>
            <pre>
              <code>
                $this->assertEquals('<div>A string literal</div>', $value);
              </code>
            </pre>
            <aside class="notes">
              <ul>
              </ul>
            </aside>
          </section>

          <section>
            <h3>Assertion Roulette</h3>
            <p>Which assertion failed? I have no idea.</p>
            <aside class="notes">
              <ul>
                <li>Indirectly related</li>
                <li>Easy to want to do many assertions w/Mocks and Spies</li>
                <li>Easy to turn stub into a spy</li>
                <li>Solution: one assert per test</li>
                <li>Solution: assert last</li>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Try: One assertion per test</h4>
            <p style="text-align:left">Bad:</p>
            <pre>
              <code>
                $this->assertEquals('John', $user->getFirstName());
                $this->assertEquals('Doe', $user->getLastName());
              </code>
            </pre>
            <p style="text-align:left">Good:</p>
            <pre>
              <code>
                $this->assertEquals('John', $user->getFirstName());
              </code>
            </pre>
            <p style="text-align:left">Good:</p>
            <pre>
              <code>
                $this->assertName('John', 'Doe', $user);
              </code>
            </pre>
          </section>

          <section>
            <h3>Fragile Test</h3>
            <p>I didn't change what this CUT!? What happened?</p>
            <aside class="notes">
              Easy to do when there are side effects; but, this would happen anyway
            </aside>
          </section>

          <section>
            <h4>Try:</h4>
            <ul>
              <li>Eliminate dependencies</li>
              <li>Eliminate side effects</li>
              <li>Eliminate shared state</li>
              <li>Avoid test over-specification</li>
            </ul>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>Test Code Duplication</h3>
            <p>Why am I repeating myself so much?</p>
            <p>Writing these tests takes way too long.</p>
            <aside class="notes">
              phpcpd will detect this
            </aside>
          </section>

          <section>
            <h4>Try:</h4>
            <ul>
              <li>Object Mother</li>
              <li>Data Builder</li>
              <li>Add abstractions where there is high afferent coupling</li>
            </ul>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>High Test Maintenance Cost</h3>
            <p>I spend more time changing tests than code!!!</p>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h4>Try:</h4>
            <ul>
              <li>Use the right test strategy for the job<br>
                <small><em>Solitary unit testing isn't a testing panacea!</em></small>
              </li>
              <li>Remove negative or low ROI tests</li>
              <li>Object Mother / Data Builder</li>
              <li>Add abstractions where there is high coupling</li>
              <li>Avoid test over-specification</li>
            </ul>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <blockquote>
              "If it stinks, change it."
              <p style="font-size:60%" class="attribution">&mdash; Grandma Beck, discussing child-rearing philosophy, "<a href="http://martinfowler.com/books/refactoring.html">Refactoring</a>"</p>
            </blockquote>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <p>Solitary unit testing makes bad OOP stinky.</p>
          </section>

        </section>

<!--
===============================================================================
            Part IV. Motivations for Solitary Unit Testing
===============================================================================
-->

        <section>
          <section>
            <h2>IV. Motivations</h2>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>Solitary unit testing enables<br>
            higher code coverage.</h3>
            <aside class="notes">
              You can get to more paths
            </aside>
          </section>

          <section>
            <h3>Solitary unit testing promotes decoupling.</h3>
            <aside class="notes">
              See example 2.
              You can test code that doesn't exist or is changing, as long as the interface doesn't change.
            </aside>
          </section>

          <section>
            <h3>Solitary unit testing is faster<br>
            than sociable unit testing.</h3>
            <aside class="notes">
              What if we had a solitary test suite we could easily run locally?
            </aside>
          </section>

          <section>
            <h3>Solitary unit testing enables<br>
            better software designs.</h3>
            <aside class="notes">
              Pure functions are inherently easier to test
            </aside>
          </section>

          <section>
            <blockquote>
              "Writing unit tests is reinventing<br>
              functional programming<br>
              in non-functional languages."
              <p class="attribution">&mdash; Christian S., <a href="http://noss.github.io/2009/02/25/writing-unit-tests-is-reinventing-functional-programming-in-non-functional-languages.html">noss.github.io</a></p>
            </blockquote>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <p>Solitary unit testing motivates us towards pure functions while allowing us to keep the benefits of OOP.</p>
          </section>

          <section>
            <blockquote>
              "It should not be underestimated how much easier these functions are to test than their state-filled counterparts."
              <p style="font-size:70%" class="attribution">&mdash; Simon Honeywell, "<a href="http://www.functionalphp.com/">Functional Programming in PHP</a>"</p>
            </blockquote>
            <aside class="notes">
            </aside>
          </section>

        </section>

<!--
===============================================================================
                               Conclusion
===============================================================================
-->

        <section>

          <section>
            <h3>Ok, but where do I start?</h3>
          </section>

          <section>
            <img src="assets/drupal-code-metrics.png">
            <small><em>Drupal 8 code metrics generated by <a href="http://www.phpmetrics.org/">phpmetrics.org</a>, see <a href="assets/d8-phpmetrics-f3f3efae7d8b47947ff273f8480dd44798cead7b.html">results</a>.</em></small>
            <aside class="notes">
              <ul>
                <li>Size = Volume</li>
                <li>cyclo b/c indicator that you could be doing too much</li>
                <li>afferent b/c a class that knows to much</li>
                <li>efferent is usually ok</li>
              </ul>
            </aside>
          </section>

          <section>
            <img src="assets/drupal-code-metrics-annotated.png">
            <aside class="notes">
              <ul>
                <li>high cyclo: break down into smaller AND good solitary unit tests</li>
                <li>high afferent: add abstractions AND good sociable tests</li>
              </ul>
            </aside>
          </section>

          <section>
            <h3 style="font-size:120%;text-align:left">Why is Symfony so successful for re-use?</h3>
            <ul>
              <li class="fragment">It's good object oriented code.</li>
              <li class="fragment">No surprise: the tests are mostly (entirely?) solitary.</li>
            </ul>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>Recap</h3>
            <ul>
              <li class="fragment">Solitary Unit Testing:
                <ul>
                  <li>Never cross boundaries</li>
                  <li>One concrete class during test</li>
                </ul>
              </li>
              <li class="fragment">A boundary is an indirect input or output.</li>
              <li class="fragment">Use Test Doubles to draw the boundary.</li>
            </ul>
          </section>

          <section style="text-align:left">
            <h3 style="font-size:120%">Solitary testable code means lower coupling</h3>
            <p class="fragment">&nbsp;&nbsp;means fewer merge conflicts (D8 feature branches?)</p>
            <p class="fragment">&nbsp;&nbsp;means higher collaboration</p>
            <p class="fragment">&nbsp;&nbsp;means faster development</p>
            <p class="fragment">&nbsp;&nbsp;means quicker innovation</p>
            <p class="fragment">&nbsp;&nbsp;means closer to "Drupal 2020" ready (Crell's session)</li>
            <p class="fragment">&nbsp;&nbsp;means cake + eating</p>
            <aside class="notes">
            </aside>
          </section>

        </section>

<!--
===============================================================================
                          Thank You!
===============================================================================
-->

        <section>

          <section>
            <h2>Come Sprint on Friday!</h2>
            <ul>
              <li>All skillsets welcome!</li>
              <li>First-timers: come find a mentor in the morning.</li>
            </ul>
            <aside class="notes">
            </aside>
          </section>

          <section>
            <h2>Feedback is Welcome!</h2>
            <a style="font-size:70%" href="https://events.drupal.org/barcelona2015/sessions/principles-solitary-unit-testing">events.drupal.org/barcelona2015/sessions/principles-solitary-unit-testing</a>
          </section>

          <section>
            <h3>References</h3>

            <ol style="font-size:80%">
              <li>"<a href="http://www.recordholders.org/en/list/memory.html#8x8">Mental Calculation World Ranking Lists</a>", Marc Jornet Sanz multiplying 8-digit numbers</li>
              <li>"<a href="http://martinfowler.com/bliki/UnitTest.html">UnitTest</a>", Martin Fowler</li>
              <li>"<a href="https://leanpub.com/wewut">Working Effectively With Unit Tests</a>", Jay Fields</li>
              <li>"<a href="http://www.williamcaputo.com/archives/000019.html">TDD Pattern: Do not cross boundaries</a>", William E. Caputo</li>
              <li>"<a href="http://c2.com/cgi/wiki?ArrangeActAssert">Arrange Act Assert</a>", Cunningham Ward</li>
              <li>"<a href="http://martinfowler.com/books/refactoring.html">Refactoring</a>", Martin Fowler</li>
              <li>"<a href="http://c2.com/cgi/wiki?ArrangeActAssert">Arrange Act Assert</a>", Ward Cunningham</p>
              <li>"<a href="http://noss.github.io/2009/02/25/writing-unit-tests-is-reinventing-functional-programming-in-non-functional-languages.html">Writing unit tests is reinventing functional programming in non-functional languages</a>", Christian S.</li>
              <li>"<a href="http://www.functionalphp.com/">Functional Programming in PHP</a>", Simon Honeywell</li>
              <li>Drupal 8 code metrics generated by <a href="http://www.phpmetrics.org/">www.phpmetrics.org</a>, see <a href="assets/d8-phpmetrics-f3f3efae7d8b47947ff273f8480dd44798cead7b.html">results</a>.</li>
            </ol>

            <aside class="notes">
            </aside>
          </section>

          <section>
            <h3>Further Reading</h3>

            <ol style="font-size:60%">
              <li>See list of references.</li>
              <li>"<a href="http://www.objectmentor.com/resources/books.html">Clean Code</a>", Robert C. Martin</li>
              <li>"<a href="http://butunclebob.com/ArticleS.UncleBob.PrinciplesOfOod">The Principles of OOD</a>", Robert C. Martin</li>
              <li>"<a href="https://mike-bland.com/2012/08/16/oop-revisited.html">Object-Oriented Programming Revisited</a>", Mike Bland</li>
              <li>"<a href="https://www.amazon.com/dp/0131177052">Working Effectively with Legacy Code</a>", Michael C. Feathers</li>
              <li>"<a href="http://martinfowler.com/articles/testing-culture.html">Goto Fail, Heartbleed, and Unit Testing Culture</a>", Martin Fowler</li>
              <li>"<a href="http://www.dwheeler.com/essays/heartbleed.html">How to Prevent the next Heartbleed</a>", David A. Wheeler</li>
              <li>"<a href="http://www.rbcs-us.com/documents/Why-Most-Unit-Testing-is-Waste.pdf">Why Most Unit Testing is Waste</a>", James O. Coplien</li>
              <li>"<a href="http://martinfowler.com/bliki/ObjectMother.html">Object Mother</a>", Martin Fowler</li>
              <li>"<a href="http://www.natpryce.com/articles/000714.html">Test Data Builders: an alternative to the Object Mother pattern</a>", Nat Pryce</li>
              <li>"<a href="http://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren't Stubs</a>", Martin Fowler</li>
              <li>"<a href="http://googletesting.blogspot.com/search/label/TotT">Google testing blog</a>"</li>
              <li>"<a href="http://jawspeak.com/2011/07/16/improving-developers-enthusiasm-for-unit-tests-using-bubble-charts/">Improving developers enthusiasm for unit tests, using bubble charts</a>", Jonathan Andrew Wolter</li>
              <li>"<a href="http://deliberate-software.com/dont-mock-concrete-classes/">Don't Mock Concrete Classes</a>", Steve Shogren</li>
              <li>"<a href="http://xunitpatterns.com/">XUnit Test Patterns</a>", George Mezaros</li>
              <li>"<a href="http://motherboard.vice.com/read/how-is-critical-life-or-death-software-tested">How Is Critical 'Life or Death' Software Tested?</a>", Michael Byrne</li>
              <li>"<a href="http://www.johndcook.com/blog/2010/05/18/pure-functions-have-side-effects/">Pure functions have side-effects</a>", John D. Cook</li>
              <li>"<a href="http://blog.stevensanderson.com/2009/08/24/writing-great-unit-tests-best-and-worst-practises/">Writing Great Unit Tests: Best and Worst Practices</a>", Steve Sanderson</li>
            </ol>

            <aside class="notes">
            </aside>
          </section>


          <section>
            <h2>Thank You!</h2>
            <p>Slides are available at<br>
            <a style="font-size:80%" href="https://github.com/josephdpurcell/principles-of-solitary-unit-testing">github.com/josephdpurcell/principles-of-solitary-unit-testing</a>
            <aside class="notes">
            </aside>
          </section>


        </section>

<!--
@todo fix colors on test examples where I want to highlight things; how do I do this? I could just use a laser pointer
@todo tie this in somehow? The advantage of solitary unit testing is that the haystack is now a cotton ball.
-->

      </div><!-- /.slides -->

      <footer class="footer">
        <a class="logo-wrapper" href="https://www.palantir.net/" title="Link to Palantir.net's website">
          <div class="logo">
            <p>Palantir.net</p>
          </div>
        </a>
      </footer>
    </div><!-- /.reveal -->

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
